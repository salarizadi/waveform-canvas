/**
 *  Copyright (c) 2025
 *  @Version : 1.0.0
 *  @Author  : https://salarizadi.ir
 *  @Repository : https://github.com/salarizadi/waveform-canvas
 *  @Description: A sleek and interactive audio visualization plugin that creates a customizable waveform player
 *  using HTML5 Canvas for high-performance rendering. Features include touch support, real-time updates, RTL support,
 *  and responsive design with optimized canvas rendering for smooth animations.
 */
!function(t){"use strict";const e=function(){self.onmessage=async function(t){const{channelData:e,segments:i,samplingQuality:s}=t.data,n=[],a=Math.floor(e.length/i),o=function(t,e,i){const s=Math.floor(t/i);switch(e){case"low":return Math.max(1,Math.floor(s/5));case"medium":default:return Math.max(1,Math.floor(s/10));case"high":return Math.max(1,Math.floor(s/20))}}(e.length,s,i);for(let t=0;t<i;t+=1e3){const s=Math.min(t+1e3,i),r=[];for(let i=t;i<s;i++){const t=i*a,s=Math.min(t+a,e.length);let n=0,h=0;for(let i=t;i<s;i+=o)n+=Math.abs(e[i]),h++;const l=n/h;r.push(l)}self.postMessage({type:"progress",progress:Math.round(s/i*100)}),n.push(...r)}const r=Math.max(...n,.01),h=n.map((t=>{const e=t/r*100;return Math.max(e,15)}));self.postMessage({type:"complete",data:h})}},i=function(e,s){this.settings=t.extend({},i.defaults,s),this.element=t(e),this.audioElement=t(this.settings.audioElement)[0],this.audioContext=this.settings.audioContext,this.isDragging=!1,this.tempProgress=0,this.waveformData=null,this.interactionEnabled=!1,this.renderQueue=[],this.isRendering=!1,this.canvas=null,this.ctx=null,this.currentProgress=0,this.devicePixelRatio=window.devicePixelRatio||1,this.init()};i.defaults={audioElement:"#audio-element",audioContext:null,segments:null,segmentGap:2,activeColor:"#2196F3",inactiveColor:"#ccc",backgroundColor:null,rtl:!1,onRendered:null,onProgressChange:null,onSeek:null,samplingQuality:"medium",loadingText:"Loading waveform...",useQueue:!1,segmentBorderRadius:2,usePadding:!1,minSegmentHeight:15},i.prototype={init:function(){this.audioContext?(this.createContainer(),this.settings.segments||(this.settings.segments=this.calculateOptimalSegments()),this.bindEvents(),this.disableInteraction(),this.addLoadingIndicator(),t(this.audioElement).one("loadedmetadata",(()=>{this.audioElement.duration&&!isNaN(this.audioElement.duration)&&(this.enableInteraction(),this.removeLoadingIndicator())})),this.setupResizeObserver()):console.error("AudioContext is required")},createContainer:function(){this.element.addClass("waveform-container").css({position:"relative",height:"36px",background:this.settings.backgroundColor||"transparent",borderRadius:"18px",overflow:"hidden",cursor:"pointer",touchAction:"none",flexGrow:1,userSelect:"none",WebkitTapHighlightColor:"transparent"}),this.canvas=t("<canvas>").css({width:"100%",height:"100%",display:"block",position:"absolute",top:0,left:0})[0],this.ctx=this.canvas.getContext("2d",{alpha:!0,willReadFrequently:!0}),this.element.append(this.canvas),this.resizeCanvas()},setupResizeObserver:function(){t(window).off("resize.waveform"),this.resizeObserver=new ResizeObserver((t=>{for(let e of t){const t=e.contentRect.width,i=e.contentRect.height;this.lastWidth===t&&this.lastHeight===i||(this.lastWidth=t,this.lastHeight=i,this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout((()=>{this.handleResize()}),100))}})),this.resizeObserver.observe(this.element[0])},handleResize:function(){const t=this.currentProgress;this.resizeCanvas(),this.waveformData&&this.updateProgress(t)},resizeCanvas:function(){const t=this.element[0].getBoundingClientRect(),e=Math.max(1,t.width),i=Math.max(1,t.height);this.canvas.width=e*this.devicePixelRatio,this.canvas.height=i*this.devicePixelRatio,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.devicePixelRatio,this.devicePixelRatio)},calculateOptimalSegments:function(){const t=this.canvas.width/this.devicePixelRatio-24;let e;e=t<=300?Math.floor(t/8):t<=600?Math.floor(t/6):t<=1200?Math.floor(t/4):Math.floor(t/2);return Math.min(Math.max(e,20),500)},render:function(){if(!this.waveformData||!this.canvas)return;const t=this.ctx,e=this.canvas.width/this.devicePixelRatio,i=this.canvas.height/this.devicePixelRatio;t.clearRect(0,0,e,i),null!==this.settings.backgroundColor&&(t.fillStyle=this.settings.backgroundColor,t.beginPath(),t.roundRect(0,0,e,i,i/2),t.fill());const s=this.settings.segmentGap*(this.waveformData.length-1),n=Math.max(1,(e-s)/this.waveformData.length),a=Math.max(0,n/(this.settings.segmentBorderRadius||3)),o=this.waveformData.length,r=this.currentProgress*o,h=Math.floor(r),l=r-h,d=(Math.max(...this.waveformData),i/100),u=Math.max(1,i*(this.settings.minSegmentHeight||15)/100);this.waveformData.forEach(((s,o)=>{const r=Math.max(1,s*d),c=Math.max(r,u);let g=o*(n+this.settings.segmentGap);this.settings.rtl&&(g=e-((o+1)*n+o*this.settings.segmentGap));const m=Math.max(0,(i-c)/2);n>0&&c>0&&(t.fillStyle=this.settings.inactiveColor,t.beginPath(),t.roundRect(g,m,Math.max(.1,n),c,a),t.fill());let f=!1,p=n,v=g;this.settings.rtl?o<h?f=!0:o===h&&(f=!0,p=n*l,v=g+(n-p)):o<h?f=!0:o===h&&(f=!0,p=n*l),f&&p>0&&c>0&&(t.fillStyle=this.settings.activeColor,t.beginPath(),t.roundRect(v,m,Math.max(.1,p),c,a),t.fill())}))},updateProgress:function(t){this.currentProgress=t,this.render()},addLoadingIndicator:function(){if(0===this.element.find(".waveform-loading-indicator").length){this.loadingIndicator=t("<div>").addClass("waveform-loading-indicator").css({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(0,0,0,0.05)",borderRadius:"18px",display:"flex",justifyContent:"center",alignItems:"center",zIndex:"10"});const e=t("<span>").html(this.settings.loadingText).css({fontSize:"10px",color:"#666",opacity:"0.7"});this.loadingIndicator.append(e),this.element.append(this.loadingIndicator)}},removeLoadingIndicator:function(){this.loadingIndicator&&this.loadingIndicator.fadeOut(300,(function(){t(this).remove()}))},bindEvents:function(){t(this.audioElement).on("loadeddata",(()=>{this.audioElement.src&&!this.waveformData&&(this.disableInteraction(),this.addLoadingIndicator(),fetch(this.audioElement.src).then((t=>t.arrayBuffer())).then((t=>{this.settings.useQueue?this.addToQueue(t):this.loadAudioData(t)})))})),t(this.audioElement).on("emptied",(()=>{this.disableInteraction(),this.addLoadingIndicator()})),t(this.audioElement).on("timeupdate",(()=>{if(!this.isDragging&&this.audioElement.duration&&!isNaN(this.audioElement.duration)){const t=this.audioElement.currentTime/this.audioElement.duration;this.updateProgress(t),this.settings.onProgressChange&&this.settings.onProgressChange(t)}})),this.element.on("mousedown touchstart",(t=>this.handleStart(t))).on("mousemove touchmove",(t=>this.handleMove(t))).on("mouseup mouseleave touchend",(t=>this.handleEnd(t)))},handleStart:function(t){if(t.preventDefault(),!this.interactionEnabled)return;this.isDragging=!0;const e=t.type.includes("mouse")?t.clientX:t.touches[0].clientX;this.lastTouchX=e,requestAnimationFrame((()=>{this.updateVisualProgress(e)}))},handleMove:function(t){if(t.preventDefault(),!this.isDragging||!this.interactionEnabled)return;const e=t.type.includes("mouse")?t.clientX:t.touches[0].clientX;requestAnimationFrame((()=>{this.updateVisualProgress(e)}))},handleEnd:function(t){t.preventDefault(),this.isDragging&&this.interactionEnabled&&(this.isDragging=!1,this.settings.onSeek&&this.settings.onSeek(this.tempProgress))},updateVisualProgress:function(t){const e=this.element[0].getBoundingClientRect(),i=e.width;let s;s=this.settings.rtl?e.right-t:t-e.left,s=Math.max(0,Math.min(i,s));let n=s/i;n=Math.max(0,Math.min(1,n)),this.tempProgress=n,this.updateProgress(n),this.settings.onProgressChange&&this.settings.onProgressChange(n)},addToQueue:function(t){this.settings.useQueue?(this.renderQueue.push(t),this.isRendering||this.processQueue()):this.processAudioData(t)},processQueue:function(){if(0===this.renderQueue.length)return void(this.isRendering=!1);this.isRendering=!0;const t=this.renderQueue.shift();this.processAudioData(t)},processAudioData:function(t){this.loadAudioData(t).then((()=>{this.settings.useQueue&&this.renderQueue.length>0?this.processQueue():this.isRendering=!1})).catch((t=>{console.error("Error processing audio data:",t),this.settings.useQueue&&this.renderQueue.length>0?this.processQueue():this.isRendering=!1}))},async loadAudioData(t){try{this.addLoadingIndicator();const i=await this.audioContext.decodeAudioData(t),s=Array.from(i.getChannelData(0)),n=(t=>{const e=t.toString(),i=new Blob([`(${e})()`],{type:"application/javascript"}),s=URL.createObjectURL(i),n=new Worker(s);return URL.revokeObjectURL(s),n})(e);return new Promise(((t,e)=>{n.onmessage=e=>{const{type:i,data:s,progress:a}=e.data;if("progress"===i){this.element.find(".waveform-loading-indicator span").html(`${this.settings.loadingText} ${a}%`)}else"complete"===i&&(this.waveformData=s,this.removeLoadingIndicator(),this.render(),this.audioElement.duration&&!isNaN(this.audioElement.duration)&&this.enableInteraction(),this.settings.onRendered&&this.settings.onRendered(this),n.terminate(),t())},n.onerror=t=>{console.error("Worker error:",t),n.terminate(),e(t)},n.postMessage({channelData:s,segments:this.settings.segments,samplingQuality:this.settings.samplingQuality})}))}catch(t){throw console.error("Error processing audio data:",t),t}},enableInteraction:function(){this.interactionEnabled=!0,this.element.css("cursor","pointer")},disableInteraction:function(){this.interactionEnabled=!1,this.element.css("cursor","not-allowed")},export:function(){return this.waveformData?{version:"1.0.0",data:this.waveformData,settings:{samplingQuality:this.settings.samplingQuality,rtl:this.settings.rtl}}:(console.warn("No waveform data available to export"),null)},restore:function(t){if(!t||!t.data||!Array.isArray(t.data))return console.error("Invalid waveform data format"),!1;try{return this.waveformData=t.data,t.settings&&(t.settings.samplingQuality&&(this.settings.samplingQuality=t.settings.samplingQuality),void 0!==t.settings.rtl&&(this.settings.rtl=t.settings.rtl)),this.render(),!0}catch(t){return console.error("Error restoring waveform data:",t),!1}},destroy:function(){this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.element.off(),t(window).off("resize.waveform"),t(this.canvas).remove(),this.element.removeData("waveform")}},t.fn.waveform=function(e){return this.each((function(){t.data(this,"waveform")||t.data(this,"waveform",new i(this,e))}))}}(jQuery);
